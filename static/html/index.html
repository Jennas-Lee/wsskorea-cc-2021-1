<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/style.css">
    <title>제1과제 채점 프로그램</title>
</head>
<body>
<header>
    <h1>21전국 1과제 채점 프로그램</h1>
    <div class="account-num">
        AWS Account
        <span>0000-0000-0000</span>
    </div>
    <a href="https://github.com/Jennas-Lee/wsskorea-cc-2021-1" target="_blank">
        <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title>
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
        </svg>
    </a>
    <button class="start-btn" id="start-btn">시작</button>
</header>
<div class="ssh-modal" id="ssh-modal" style="display: none">
    <h3>Bastion Server SSH에 접속합니다.</h3>
    <table>
        <tr>
            <td><label for="ssh-host">Host</label></td>
            <td><input type="text" id="ssh-host"></td>
        </tr>
        <tr id="ssh-password-tr" style="display: none;">
            <td><label for="ssh-password">Password</label></td>
            <td><input type="text" id="ssh-password"></td>
        </tr>
        <tr id="ssh-key-tr">
            <td><label for="ssh-key">Key Pair</label></td>
            <td><input type="file" id="ssh-key"></td>
        </tr>
        <tr>
            <td colspan="2">
                <label for="ssh-auth-1">
                    Password
                    <input type="radio" name="ssh-auth" id="ssh-auth-1" value="1">
                </label>
                <label for="ssh-auth-2">
                    Key Pair
                    <input type="radio" name="ssh-auth" id="ssh-auth-2" value="2" checked>
                </label>
            </td>
        </tr>
    </table>
    <span class="ssh-error" id="ssh-error"></span>
    <span class="ssh-btn">
        <button id="ssh-btn">접속</button>
    </span>
    <script>
        const sshAuth1 = document.getElementById('ssh-auth-1');
        const sshAuth2 = document.getElementById('ssh-auth-2');
        const sshPasswordTr = document.getElementById('ssh-password-tr')
        const sshKeyTr = document.getElementById('ssh-key-tr')

        const sshAuthChangeEvent = (num) => {
            if (num === 1) {
                sshPasswordTr.setAttribute('style', 'display: table-row;');
                sshKeyTr.setAttribute('style', 'display: none;');
            } else if (num === 2) {
                sshPasswordTr.setAttribute('style', 'display: none;');
                sshKeyTr.setAttribute('style', 'display: table-row;');
            }
        }

        sshAuth1.addEventListener('change', (event) => {
            sshAuthChangeEvent(1);
        });
        sshAuth2.addEventListener('change', (event) => {
            sshAuthChangeEvent(2);
        })
    </script>
</div>
</body>
<script>
    const ipcRenderer = require('electron').ipcRenderer;
    const startBtn = document.getElementById('start-btn');
    const sshModal = document.getElementById('ssh-modal');
    const sshModalError = document.getElementById('ssh-error');
    const sshModalBtn = document.getElementById('ssh-btn')

    startBtn.addEventListener('click', () => {
        ipcRenderer.send('startBtnClick');
    });

    sshModalBtn.addEventListener('click', () => {
        const host = document.getElementById('ssh-host').value;
        const option = parseInt(document.querySelector('input[name="ssh-auth"]:checked').value);
        let password = "";
        let key = "";

        if (option === 1) {
            password = document.getElementById('ssh-password').value;
        } else if (option === 2) {
            key = document.getElementById('ssh-key').files[0];
        }

        if (host.length === 0) {
            sshModalError.innerText = 'Host 주소를 입력하세요.';
        } else if (option === 1 && password.length === 0) {
            sshModalError.innerText = 'Password를 입력하세요.';
        } else if (option === 2 && key === undefined) {
            sshModalError.innerText = 'Key Pair를 선택하세요.';
        } else {
            sshModalBtn.setAttribute('disabled', 'true');
            sshModalBtn.innerText = '연결중';
            ipcRenderer.send('getBastionServerSSH', {
                'host': host,
                'password': password,
                'keypair': key,
                'option': option
            });
        }
    });

    ipcRenderer.on('start-scoring', (event) => {
        startBtn.setAttribute('disabled', 'true');
        startBtn.innerText = '채점중';
        sshModal.setAttribute('style', 'display: block;');
    });

    ipcRenderer.on('connection-failed-bastion-server', (event, payload) => {
        if (payload['type'] === 1) {
            sshModalError.innerText = '연결에 실패했습니다. 연결이 되지 않으면 채점이 불가능합니다.';
        } else if (payload['type'] === 2) {
            sshModalError.innerText = '비밀번호 또는 키페어가 잘못되었습니다. 접속에 실패했습니다.';
        } else if (payload['type'] === 3) {
            alert('오류가 발생했습니다. 다시 시도해주세요. 이 메시지가 계속되면 Github Issue를 남겨주세요.');
        }

        sshModalBtn.innerText = '접속';
        sshModalBtn.removeAttribute('disabled');
    });

    ipcRenderer.on('ready-bastion-server', (event) => {
        sshModal.setAttribute('style', 'display: none;');
    });
</script>
</html>